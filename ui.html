<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Hoot Spotter</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 20px;
      margin: 0;
      color: #333;
    }
    h2 {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 10px;
      margin-bottom: 15px;
    }
    button {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    button:hover {
      background: #f5f5f5;
    }
    #run-scan {
      background: #FFC107;
      border-color: #FFA000;
      color: #333;
      grid-column: 1;
    }
    #run-scan:hover {
      background: #FFB300;
    }
    .mode-selector {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: hidden;
    }
    .mode-option {
      flex: 1;
      padding: 8px 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: white;
    }
    .mode-option.active {
      background: #4CAF50;
      color: white;
      font-weight: 500;
    }
    .filter-section {
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #f9f9f9;
    }
    .filter-section h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 14px;
      color: #666;
    }
    select {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    #results {
      margin-top: 20px;
      max-height: 350px;
      overflow-y: auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .result-group {
      margin-bottom: 20px;
    }
    .group-header {
      font-weight: 600;
      margin-bottom: 8px;
      padding: 4px 8px;
      background: #f0f0f0;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .group-header .component-type {
      font-size: 12px;
      padding: 2px 6px;
      background: #e0e0e0;
      border-radius: 12px;
    }
    .result-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 4px;
      background: #f9f9f9;
    }
    .result-row:hover {
      background: #f0f0f0;
    }
    .result-details {
      flex-grow: 1;
    }
    .layer-path {
      font-size: 12px;
      color: #666;
      margin-bottom: 2px;
    }
    .property {
      font-weight: 500;
    }
    .property-value {
      font-family: 'Menlo', 'Monaco', monospace;
      font-size: 12px;
      padding: 1px 4px;
      background: #eee;
      border-radius: 3px;
    }
    .focus-button {
      margin-left: 10px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 16px;
      padding: 4px;
      border-radius: 4px;
    }
    .focus-button:hover {
      background: #e0e0e0;
    }
    .match {
      border-left: 4px solid #4CAF50;
    }
    .mismatch {
      border-left: 4px solid #F44336;
    }
    .status-icon {
      margin-right: 8px;
      font-size: 14px;
    }
    .no-results {
      padding: 20px;
      text-align: center;
      color: #666;
    }
    .filter-controls {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    .filter-controls label {
      margin-right: 10px;
    }
    .filter-toggle {
      margin-right: 15px;
    }
    .summary {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    .stat {
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
    }
    
    /* Harmony Mode Styles */
    .harmony-score {
      display: flex;
      flex-direction: column;
      padding: 10px;
      border-radius: 6px;
      background: #f9f9f9;
      margin-bottom: 15px;
    }
    .harmony-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .harmony-title {
      font-weight: 600;
    }
    .overall-score {
      font-size: 24px;
      font-weight: bold;
      padding: 5px 12px;
      border-radius: 20px;
      color: white;
    }
    .score-great {
      background: #4CAF50;
    }
    .score-good {
      background: #8BC34A;
    }
    .score-ok {
      background: #FFC107;
    }
    .score-poor {
      background: #FF9800;
    }
    .score-bad {
      background: #F44336;
    }
    .score-metrics {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
    }
    .score-metric {
      text-align: center;
      flex: 1;
    }
    .score-value {
      font-weight: bold;
      font-size: 18px;
    }
    .score-label {
      font-size: 12px;
      color: #666;
    }
    .radar-chart {
      width: 100%;
      height: 200px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h2>
    <span>Hoot Spotter</span>
    <span style="font-size: 24px;">🦉</span>
  </h2>
  
  <div class="mode-selector">
    <div class="mode-option active" id="compliance-mode">Compliance Check</div>
    <div class="mode-option" id="harmony-mode">Design Harmony</div>
  </div>
  
  <div class="filter-section">
    <h3>Component Type Filter</h3>
    <select id="component-type-filter">
      <option value="">All Components</option>
      <!-- Component types will be added here dynamically -->
    </select>
  </div>
  
  <div class="controls">
    <button id="set-control">Set Control</button>
    <button id="set-references">Set References</button>
    <button id="run-scan">Run Scan</button>
    <button id="close">Close Plugin</button>
  </div>

  <div id="summary" class="summary" style="display: none;">
    <div class="stat">
      <div class="stat-value" id="total-count">0</div>
      <div class="stat-label">Total Properties</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="match-count">0</div>
      <div class="stat-label">Matching</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="mismatch-count">0</div>
      <div class="stat-label">Different</div>
    </div>
  </div>
  
  <div class="filter-controls" style="display: none;" id="filter-section">
    <div class="filter-toggle">
      <input type="checkbox" id="show-matches" checked>
      <label for="show-matches">Show Matches</label>
    </div>
    <div class="filter-toggle">
      <input type="checkbox" id="show-mismatches" checked>
      <label for="show-mismatches">Show Differences</label>
    </div>
  </div>

  <div id="results">
    <!-- Results will be injected here -->
  </div>

  <script>
    // Current mode tracking
    let currentMode = "compliance";
    let selectedComponentType = "";
    let componentTypes = [];
    
    // Mode switching
    document.getElementById("compliance-mode").onclick = () => {
      document.getElementById("compliance-mode").classList.add("active");
      document.getElementById("harmony-mode").classList.remove("active");
      currentMode = "compliance";
      parent.postMessage({ 
        pluginMessage: { 
          type: "set-mode", 
          mode: "compliance" 
        } 
      }, "*");
    };
    
    document.getElementById("harmony-mode").onclick = () => {
      document.getElementById("harmony-mode").classList.add("active");
      document.getElementById("compliance-mode").classList.remove("active");
      currentMode = "harmony";
      parent.postMessage({ 
        pluginMessage: { 
          type: "set-mode", 
          mode: "harmony" 
        } 
      }, "*");
    };
    
    // Component type filter
    document.getElementById("component-type-filter").onchange = (e) => {
      selectedComponentType = e.target.value;
      parent.postMessage({ 
        pluginMessage: { 
          type: "set-component-type-filter", 
          componentType: selectedComponentType 
        } 
      }, "*");
    };
    
    // Request component types on load
    window.onload = () => {
      parent.postMessage({ 
        pluginMessage: { 
          type: "get-component-types"
        } 
      }, "*");
    };

    document.getElementById("set-control").onclick = () => {
      parent.postMessage({ pluginMessage: { type: "set-control" } }, "*");
    };

    document.getElementById("set-references").onclick = () => {
      parent.postMessage({ pluginMessage: { type: "set-references" } }, "*");
    };

    document.getElementById("run-scan").onclick = () => {
      parent.postMessage({ pluginMessage: { type: "run-scan" } }, "*");
    };

    document.getElementById("close").onclick = () => {
      parent.postMessage({ pluginMessage: { type: "close-plugin" } }, "*");
    };
    
    // Filter functionality
    function applyFilters() {
      const showMatches = document.getElementById("show-matches").checked;
      const showMismatches = document.getElementById("show-mismatches").checked;
      
      const matchRows = document.querySelectorAll('.match');
      const mismatchRows = document.querySelectorAll('.mismatch');
      
      matchRows.forEach(row => {
        row.style.display = showMatches ? 'flex' : 'none';
      });
      
      mismatchRows.forEach(row => {
        row.style.display = showMismatches ? 'flex' : 'none';
      });
      
      // Hide empty groups
      document.querySelectorAll('.result-group').forEach(group => {
        const visibleRows = group.querySelectorAll('.result-row[style="display: flex;"]');
        group.style.display = visibleRows.length > 0 ? 'block' : 'none';
      });
    }
    
    document.getElementById("show-matches").addEventListener("change", applyFilters);
    document.getElementById("show-mismatches").addEventListener("change", applyFilters);
    
    // Helper function to get score class
    function getScoreClass(score) {
      if (score >= 90) return "score-great";
      if (score >= 80) return "score-good";
      if (score >= 70) return "score-ok";
      if (score >= 60) return "score-poor";
      return "score-bad";
    }
    
    // Render harmony score UI with enhanced insights
    function renderHarmonyScore(container, harmonyData) {
      const scoreDiv = document.createElement("div");
      scoreDiv.className = "harmony-score";
      
      // Header with overall score
      const headerDiv = document.createElement("div");
      headerDiv.className = "harmony-header";
      
      const titleSpan = document.createElement("div");
      titleSpan.className = "harmony-title";
      titleSpan.textContent = `${harmonyData.referenceLayer}`;
      
      const scoreSpan = document.createElement("div");
      scoreSpan.className = `overall-score ${getScoreClass(harmonyData.harmony.overallScore)}`;
      scoreSpan.textContent = harmonyData.harmony.overallScore;
      
      headerDiv.appendChild(titleSpan);
      headerDiv.appendChild(scoreSpan);
      scoreDiv.appendChild(headerDiv);
      
      // Component type tag
      const typeDiv = document.createElement("div");
      typeDiv.textContent = harmonyData.componentType || "Unknown Component";
      typeDiv.style.fontSize = "12px";
      typeDiv.style.color = "#666";
      typeDiv.style.marginBottom = "10px";
      scoreDiv.appendChild(typeDiv);
      
      // Score metrics
      const metricsDiv = document.createElement("div");
      metricsDiv.className = "score-metrics";
      
      const metrics = [
        { name: "Color", value: harmonyData.harmony.colorScore },
        { name: "Spacing", value: harmonyData.harmony.spacingScore },
        { name: "Typography", value: harmonyData.harmony.typographyScore },
        { name: "Shape", value: harmonyData.harmony.shapeScore }
      ];
      
      metrics.forEach(metric => {
        const metricDiv = document.createElement("div");
        metricDiv.className = "score-metric";
        
        const valueDiv = document.createElement("div");
        valueDiv.className = "score-value";
        valueDiv.textContent = metric.value;
        
        // Use a color based on score value
        if (metric.value >= 90) valueDiv.style.color = "#4CAF50";
        else if (metric.value >= 80) valueDiv.style.color = "#8BC34A";
        else if (metric.value >= 70) valueDiv.style.color = "#FFC107";
        else if (metric.value >= 60) valueDiv.style.color = "#FF9800";
        else valueDiv.style.color = "#F44336";
        
        const labelDiv = document.createElement("div");
        labelDiv.className = "score-label";
        labelDiv.textContent = metric.name;
        
        metricDiv.appendChild(valueDiv);
        metricDiv.appendChild(labelDiv);
        metricsDiv.appendChild(metricDiv);
      });
      
      scoreDiv.appendChild(metricsDiv);
      
      // Display insights
      if (harmonyData.insights && harmonyData.insights.length > 0) {
        const insightsDiv = document.createElement("div");
        insightsDiv.style.marginTop = "15px";
        insightsDiv.style.padding = "10px";
        insightsDiv.style.background = "#f0f0f0";
        insightsDiv.style.borderRadius = "4px";
        insightsDiv.style.fontSize = "13px";
        
        const insightsList = document.createElement("ul");
        insightsList.style.margin = "0";
        insightsList.style.paddingLeft = "20px";
        
        harmonyData.insights.forEach(insight => {
          const item = document.createElement("li");
          item.textContent = insight;
          item.style.marginBottom = "5px";
          insightsList.appendChild(item);
        });
        
        insightsDiv.appendChild(insightsList);
        scoreDiv.appendChild(insightsDiv);
      }
      
      // Focus button
      const focusBtn = document.createElement("button");
      focusBtn.textContent = "🎯";
      focusBtn.className = "focus-button";
      focusBtn.title = "Focus on this component";
      focusBtn.style.marginTop = "10px";
      focusBtn.style.alignSelf = "flex-end";
      focusBtn.onclick = () => {
        parent.postMessage({
          pluginMessage: { type: "focus-node", nodeId: harmonyData.nodeId },
        }, "*");
      };
      
      scoreDiv.appendChild(focusBtn);
      container.appendChild(scoreDiv);
    }

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === "component-types") {
        // Populate the component type filter dropdown
        componentTypes = msg.componentTypes;
        const select = document.getElementById("component-type-filter");
        
        componentTypes.forEach(type => {
          const option = document.createElement("option");
          option.value = type;
          option.textContent = type;
          select.appendChild(option);
        });
      }
      
      if (msg.type === "scan-complete") {
        const container = document.getElementById("results");
        container.innerHTML = "";
        
        // Handle empty results
        if (!msg.payload[0].results || msg.payload[0].results.length === 0) {
          container.innerHTML = "<div class='no-results'>No results found! Try adjusting your filter or selecting different components.</div>";
          document.getElementById("filter-section").style.display = "none";
          document.getElementById("summary").style.display = "none";
          return;
        }
        
        // If in harmony mode, render harmony scores
        if (msg.mode === "harmony") {
          document.getElementById("filter-section").style.display = "none";
          document.getElementById("summary").style.display = "none";
          
          msg.payload[0].results.forEach(result => {
            renderHarmonyScore(container, result);
          });
          
          return;
        }
        
        // Otherwise, show compliance check results
        document.getElementById("filter-section").style.display = "flex";
        document.getElementById("summary").style.display = "flex";
        
        // Update summary stats
        const totalCount = msg.payload[0].results.length;
        const matchCount = msg.payload[0].results.filter(r => r.match).length;
        const mismatchCount = totalCount - matchCount;
        
        document.getElementById("total-count").textContent = totalCount;
        document.getElementById("match-count").textContent = matchCount;
        document.getElementById("mismatch-count").textContent = mismatchCount;

        // Group results by component and layer
        const groupedResults = {};
        msg.payload[0].results.forEach(result => {
          // Use component type and layer as the key
          const componentType = result.componentType || "Unknown";
          const layerKey = `${result.controlLayer}–${result.referenceLayer}`;
          const groupKey = `${componentType}|${layerKey}`;
          
          if (!groupedResults[groupKey]) {
            groupedResults[groupKey] = {
              componentType: componentType,
              layerKey: layerKey,
              results: []
            };
          }
          groupedResults[groupKey].results.push(result);
        });
        
        // Create HTML for each group
        for (const key in groupedResults) {
          const group = groupedResults[key];
          const groupDiv = document.createElement("div");
          groupDiv.className = "result-group";
          
          const groupHeader = document.createElement("div");
          groupHeader.className = "group-header";
          
          const headerText = document.createElement("span");
          headerText.textContent = group.layerKey;
          
          const componentTypeSpan = document.createElement("span");
          componentTypeSpan.className = "component-type";
          componentTypeSpan.textContent = group.componentType;
          
          groupHeader.appendChild(headerText);
          groupHeader.appendChild(componentTypeSpan);
          groupDiv.appendChild(groupHeader);
          
          group.results.forEach(r => {
            const row = document.createElement("div");
            row.className = `result-row ${r.match ? 'match' : 'mismatch'}`;
            
            const iconSpan = document.createElement("span");
            iconSpan.className = "status-icon";
            iconSpan.innerHTML = r.match ? "✅" : "❌";
            
            const detailsDiv = document.createElement("div");
            detailsDiv.className = "result-details";
            
            const propertyDetails = document.createElement("div");
            
            // Format the detail string for better readability
            const detailParts = r.detail.split(' vs ');
            
            propertyDetails.innerHTML = `
              <span class="property">${r.prop}:</span> 
              <span class="property-value">${detailParts[0]}</span> vs 
              <span class="property-value">${detailParts[1]}</span>
            `;
            
            detailsDiv.appendChild(propertyDetails);
            
            const focusBtn = document.createElement("button");
            focusBtn.textContent = "🎯";
            focusBtn.className = "focus-button";
            focusBtn.title = "Focus on this layer";
            focusBtn.onclick = () => {
              parent.postMessage({
                pluginMessage: { type: "focus-node", nodeId: r.nodeId },
              }, "*");
            };
            
            row.appendChild(iconSpan);
            row.appendChild(detailsDiv);
            row.appendChild(focusBtn);
            groupDiv.appendChild(row);
          });
          
          container.appendChild(groupDiv);
        }
        
        // Apply initial filters
        applyFilters();
      }
    };
  </script>
</body>
</html>